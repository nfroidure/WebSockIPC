<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>WebSockIPC</title>
    </head>
    <body>
        <h1>WebSockIPC</h1>
        <p>A simple use case of VarStreams. It synchronize each clients UIs using VarStreams and Javascript Setters/Getters.</p>
        <div>
			<label>Name : <input type="text" value="" id="name" class="sync" /></label><br />
			<label>Lastname : <input type="text" value="" id="lastname" class="sync" /></label><br />
			<label>Email : <input type="text" value="" id="email" class="sync" /></label><br />
			<label>Subject : <input type="text" value="" id="subject" class="sync" /></label><br />
			<label>Message :<br />
            <textarea id="message" style="width:60%;" rows="10" class="sync"></textarea></label><br />
			<input type="button" id="button" value="Send" />
        </div>
	<script type="text/javascript" src="VarStreamReader.js"></script> <!-- Added localy for facility but probably outdated, see github repo : https://github.com/nfroidure/VarStream -->
	<script type="text/javascript">
	// Referencing the web socket connection
    window.WebSocket = window.WebSocket || window.MozWebSocket;
    var connection = new WebSocket('ws://127.0.0.1:1337');
	// Creating the common var tree
	var varTree={
		};
	varTree.form={};
	// Parsing form inputs
	var inputs=document.getElementsByClassName('sync');
	for(var i=inputs.length-1; i>=0; i--)
		{
		if(inputs[i].hasAttribute('id'))
			{
			(function()
				{
				var name=inputs[i].getAttribute('id');
				// Linking the form element to it's vartree value
				varTree.form.__defineGetter__(name, function() {
					console.log('In the getter of '+name);
					document.getElementById(name).value;
					});  
				varTree.form.__defineSetter__(name, function(value) {
					console.log('In the setter of '+name+' = '+value);
					document.getElementById(name).value=value;
					});
				// Looking for input update and synchronizing with server
				document.getElementById(name).addEventListener('change',function(e) {
					console.log('In the listener of '+e.target.getAttribute('id'));
					varTree.form[e.target.getAttribute('id')]=document.getElementById(e.target.getAttribute('id')).value;
					connection.send('form.'+e.target.getAttribute('id')+'='+document.getElementById(e.target.getAttribute('id')).value);
					});
				})();
			}
		}
	// Initializing stream reader
	var myStreamReader=new VarStreamReader(varTree);
	// Connecting to the server
    connection.onopen = function ()
		{
		console.log('Websocket opened !');
		};
    connection.onerror = function (error)
		{
		console.log('Websocket error !');
		};
	// Catching synchronization message
    connection.onmessage = function (message)
		{
		console.log('Received: '+message.data);
		myStreamReader.read(message.data);
		};
	</script>
    </body>
</html>
